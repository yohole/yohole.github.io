---
title: 新安银行存管
tags:
  - 存管
  - 改造
categories:
  - 技术
  - 方案
date: 2018-10-23 20:24:28
---


[TOC]

# 简介

​	**新安银行**是一家新兴的民营银行，属于金融办验收和批准的存管白名单银行。本次是通过 **钜石科技** 对接新安银行([钜石API在线文档](https://apidata.rockfintech.com/doc/build/depositxinan.html))，钜石的接口设计与富友的核心思想类似，但是交互方式和细节实现有一定的差别，包括加密、验签、数据的交互等等。



## 交流方式  
> 合众-钜石唯一官方互怼QQ群：934390370
> 
1. 以 **合众技术-姓名**格式申请入群
2. 打个招呼以混个脸熟
3. 识人，辨清那些是假装技术的产品和假装产品的技术，以免怼错人
4. **带着意义的问题** 疯狂开始@人



## 问题上升

> 以解决当前问题为主，后续问题为次的原则

1. 对于组内已咨询和已解决的问题，优先咨询组内人员，为组员解答最多问题的组员奖励神秘奖品
2. 对于组内已确认但对方也明确过暂不改但也不影响大局的问题，只吐槽十次即可回归正常开发，佛性开发
3. 对于组内已确认但对方也明确过待整改但影响接口调用的问题，请汇总给我即可，无须再QQ群一直追问



# 接口初步解读

#### 接口安全（钜石提供）

1. 商户提出钜石存管系统接入申请后，从钜石平台获取商户rft-key以及商户rft-secret，用以商户签名；
2. 商户与钜石平台互换以2048位生成的RSA公钥，用以数据加解密；
3. 通过MD5(rft-key+rft-secret)获取MD5签名串md5_key;
4. 接口调用前，用商户md5_key与请求参数字符串(请求串的生成方式参考右方示例)拼接后进行MD5签名；
5. 将接口请求参数与步骤3所得签名数据合并后用钜石存管平台公钥进行RSA加密处理，对加密结果进行base64编码后传输；
6. 钜石平台收到商户请求后，用钜石存管平台私钥对接口请求数据进行base64解码后进行解密处理；
7. 以商户md5_key对商户接口请求数据进行MD5签名，签名结果与商户上传的签名结果一致则认证成功，否则认证失败；
8. 商户收到钜石存管系统接口调用响应以及任何回调通知接口，都需要同样进行以上验证，以免数据响应被篡改或者由第三方伪造发起回调通知接口。

>我在钜石提供的Java Demo基础上，写了理财涉及到的大部分接口，均测试通过。
>
>资料地址为：\\10.10.30.3\技术中心-新2\新安银行对接\理财相关资料包\



#### 数据报文签名规则（钜石提供）

如果没有特殊说明，则均为UTF-8编码格式，报文内容采均用JSON进行描述，JSON报文的签名算法采用MD5算法进行摘要计算，对于不同的商户在入网申请时必须和钜石公司申请特定的校验字符串进行身份标识 (rft-key和rft-secret) ，JSON签名序列化格式描述如下：

1. 签名域(sign)只出现在顶级JSON对象中。

2. 对于JSON对象中除签名域(sign)之外的所有key值进行alphabet序进行排序。

   如果是简单格式则采用key=value的形式对该属性进行描述。

   如果是 JSON 对象则递归使用该规则；

   如果是简单数组则采用key=value1&value2&value3的形式进行描述；

   如果是对象数组，则依序对JSON对象递归使用该规则，并依照数组顺序对该JSON对象的序列化格式进行key=serial1&seril2&serial3的形式进行描述。

3. 对所有的属性元算采用key1=value1&key2=value2&key3=value3的形式进行拼接形成一个完整的JSON对象格式化序列serialize

4. 如果是顶级JSON对象则采用公式sign=MD5(serial+MD5(rft-key+rft-secret))进行签名计算，如果非顶级JSON对象则返回步骤1进行继续运算。

> 本次理财对接新存管均采用由架构组提供的SDK开发，涉及到的所有加解密、验签、公共请求头封装均使用SDK公共方法处理，如果SDK未能提供相关处理请及时提出，个人开发不能自己另起炉灶



#### 交互流程图

##### API交互流程

```sequence
合众->钜石: POST发起请求 
钜石 -> 合众: POST同步响应 
```

------

##### 页面交互流程

```sequence
Title: H5页面交互流程
合众->钜石: POST发起请求，会传入同步失败/成功、异步回调等三个字段 
Note left of 合众: 页面由区分是PC还是H5
钜石 -> 合众: 同步响应，并返回跳转页面的URL
合众-->银行H5: 点击URL跳转
Note right of 银行H5: 银行页面会实时反馈部分失败情况
银行H5 --> 合众: 同步跳转成功/失败地址
钜石 -> 合众: 异步回调返回最终结果
```





# 理财改造点

### 新安银行与现有差异



#### 业务差异

##### 企业户
  - 红包户：理财营销出账专用，包括红包返现、羊毛立返、邀请好友、签到等活动现金奖励等出账使用
  - 手续费户：跟业务场景绑定入账，无法单独调用入账，理财本次对接无需使用



##### 手续费

  - 提现/充值手续费：充值/提现手续费收取无需授权，直接在调用充值/提现接口时候直接传入手续费字段授权

    > 手续费收取是外扣模式：提现/充值 500元，手续费2元，则用户账户出/入账502元，否则会报余额不足

      - 放款手续费：需要预先页面授权，但是放款接口调用在匹配系统中，若需要，则由理财系统处理
      - 债转手续费：需要预先页面授权，但是债转接口调用在匹配系统中，若需要，则由理财系统处理



##### 业务签约

  > **签约** 为钜石的官方业务术语，对应富友的 **授权**，签约的两要素为 **金额 **和 **期限**

  - 原提现手续费授权，取消
  - 自动投标签约，保持
  - 自动债转授权，新增
  - 债转手续费授权 新增
  - 放款手续费授权 新增

  > 初次授权调用的接口与后续因为金额或者期限不足而调整的接口不一样
  >
  > 钜石官方说法为**在签状态的只能调用累加签约接口** 。
  >
  > 钜石提供 自动投标签约与自动债转签约 复合授权的单个接口，但累计签约只能单项



##### 资金交易模式

  - **富友**资金交易模式

    > 出账人可为企业，如营销户等


```mermaid
graph LR
A(出账人可用余额) -->|预授权/直接冻结| B(出账人冻结金额)
    B -->|转账/放款| C(入账人冻结余额)
    C --> |解冻|D(入账人可用余额)
```



  - **钜石**资金交易模式

    > 钜石模式在**满足签约**的前提下，资金操作是直接是可用余额到可用余额，无需经过冻结余额，包括红包户出账

    ```mermaid
    graph LR
    A(出账人可用余额) -->|转账/放款| B(入账人可用余额)
    ```



#### 接口差异

- 页面交互

  - 富友的页面跳转是理财系统后台构造form表单返回给前端页面而跳转

  - 钜石的页面跳转是同步请求接口然而返回跳转URL进行跳转

    > 富友的页面是区分H5和PC，而钜石同样是在公共请求头有字段区分


  - 钜石的提现/充值/开户等页面能实时弹窗反馈部分失败情况，但是主要的错误仍然依赖回调地址

  - 钜石页面H5接口提供了三个需要注意的地址字段

    > success_url：交易成功同步跳转地址，钜石系统校验通过并提交到银行成功后的跳转路由或者页面地址（这里跟富友友很大差别，钜石不会附带任何参数返回，但我们在URL上附带参数）
    >
    >
    >
    > fail_url：交易失败同步跳转地址，准确来说应该是钜石与银行交互失败的跳转地址，因为简单校验错误会在页面实时弹窗不会跳转（这里跟富友友很大差别，钜石不会附带任何参数返回，但我们再URL上附带参数）
    >
    >
    >
    > callback_url：最终交易状态异步回调地址，5s-1min触达，会返回接口文档描述的所有字段，接受成功之后需要返回  “success” 字符串，否则一共会回调五次



#### 坑点

##### 用户标记
> 钜石系统标记唯一用户的字段众多且凌乱，不同接口要求传不同的字段，同一意思的字段，有些在接口的命名不一样，以下信息在开户成功之后均需要存表**

  - cert_no：身份证

  - card_no：电子账户（与富友账号ips_acct_no类似）

  - customer_no：客户号

  - serial_no：三方绑定编号(绑卡是返回的编号，API解绑的时候要根据这个绑定编号解绑，页面用户授权解绑则不需要)

  - bank_card_no：银行卡号

  - mobile：银行预留手机号（跟现有富友一样，该字段在银行页面要求是银行卡预留手机字段，跟平台登陆用户名可以不一致）


##### 流水号
> 钜石标记唯一的一次交易字段，同样众多却混乱，在每次发起请求和接受响应均需要入库**

  - uuid：API公共请求参数之一，户发起接口调用之前必须生成一个唯一标识发送给服务器，钜石响应会返回该字段

  - out_serial_no：申请流水号，必填，用于交易的唯一性标识，32(位数)

  - sequence_id：钜石生成并每次交易都返回的处理流水号—标记商户发起的接口请求都对应钜石系统内唯一的处理流水号

    > 钜石反馈，排查问题可能同时需要以上三个字段，我们需要统一封装保存该三个字段



##### 业务绑定

  - 资金冻结，目前只有冻结（余额-->冻结）和冻结撤销（东给-->冻结）两种，没有解冻的概念，冻结撤销需要原资金冻结申请流水号(**out_serial_no**)
  - 解绑，API解绑与页面解绑均需要开户返回的三方编号(**serial_no**)
  - 签约，对于在签的业务，若需要增加额度或者期限在调用累加签约接口的时候需要原签约流水号**(origin_serial_no)**
  - 红包户出账，红包出账后可以根据原交易流水号(**origin_serial_no**)撤回




### 理财业务涉及接口

| 优先度 |      钜石接口代码       |                      接口说明与场景应用                      |
| ------ | :---------------------: | :----------------------------------------------------------: |
| 1      |    create_account_p     |            个人/企业开设电子银行账户接口（页面）             |
| 1      |     set_password_p      |                       重置密码（页面）                       |
| 2      |    unbind_bank_card     |                        解绑银行卡接口                        |
| 1      |     account_mobile      |        电子账户手机号查询（查询用户除银行卡外的信息）        |
| 2      |      binding_list       |            绑卡关系查询（查询用户绑定的银行卡号）            |
| 1      |     account_balance     |                       电子账户余额查询                       |
| 2      |     marketing_query     |                        营销户余额查询                        |
| 1      |   find_account_by_id    |                     按证件号查询电子账号                     |
| 4      |  account_transactions   |                 查询个人与企业户的出入账明细                 |
| 4      | create_account_sr_query |            开户结果查询（需要原开户order_id查询）            |
| 1      |    bind_bank_card_p     |           单独绑卡页面（处理存量用户迁移后的绑卡）           |
| 4      |   unbind_bank_card_p    |                        解绑银行卡页面                        |
| 1      |         frozen          |                           资金冻结                           |
| 1      |        unfrozen         |   资金冻结撤销（需要原来资金冻结流水单号origin_serial_no）   |
| 3      |      frozen_query       |   资金冻结接口（需要原来资金冻结流水单号origin_serial_no）   |
| 1      |      bank_recharge      |                           网银充值                           |
| 1      |       recharge_p        |                         快捷充值页面                         |
| 1      |       withdraw_p        |                           提现页面                           |
| 1      |     sign_transfer_p     |                 转让方转让手续费签约（页面）                 |
| 1      |   sign_transfer_check   |                      转让手续费签约查询                      |
| 2      |     revoke_transfer     |                   撤销转让人转让手续费签约                   |
| 1      |      sign_again_p       | 累加签约（已在签的签约只能使用该接口累加，金额是累加，期限是覆盖） |
| 3      |       sign_fee_p        |       放款手续费签约（既能收取借款人，也能收取出借人）       |
| 1      |  coupon_bank_recharge   |               红包户充值，红包户充值的唯一途径               |
| 2      | sign_credit_transfer_p  |                   自动债权转让签约（页面）                   |
| 1      |     authorization_p     | 业务授权自动投标、自动债转（相当于sign_credit_transfer_p和sign_auto_bid_p两个接口的复合版本） |
| 1      |     money_dispatch      |                           红包发放                           |
| 3      |      money_revoke       |                           红包撤销                           |
| 3      |        serial_no        |                         红包发放查询                         |
| 3      |       bank_quota        |                       银行充值限额查询                       |
| 4      |     batch_coupon_b      |                         批量红包发放                         |
|        |                         |                                                              |
|        |                         |                                                              |
|        |                         |                                                              |



### 理财系统修改点

> 该部分是明确需要改动，但具体改动依赖产品输出的原型和交互流程



#### 业务调整

##### 开户

  - 成功：同步地址仅能跳转成功地址，钜石不会附带任何业务参数，需要在同步跳转地址构造参数，例如平台用户ID，以便系统或用户实时掌握对应用户初步开户情况，最终结果依赖回调

    >  这里更多是让系统知道对应用户初步开户成功，因为用户能在银行开户页面实时得知初步开户结果
    >
    > **难点：**同步地址成功跳转，但异步回调通知开户失败（如：四要素不通过），这时如何反馈给用户并作下一步处理？

  - 失败：同步地址仅能跳转失败地址，这个时候并不能得知开户失败原因，系统也只能依靠回调后才能得知，后台需要入库保存失败结果并根据调整反馈给用户下一步流程

------



##### 签约(授权)

  - 钜石的签约对应富友的授权，目前取消原部分授权，而增加了部分签约流程

    >  **富友的授权是可以在开户的页面通过“下一步”一并处理了，而钜石的开户与各个签约都是单独分开的页面接口**

  - 签约类型

    > 备注为必须的本次必须开发，签约的两要素分别为期限和金额

    |    签约类型    | 钜石 | 富友 |              备注              |
    | :------------: | :--: | :--: | :----------------------------: |
    | 提现手续费授权 |  无  |  有  | 钜石充值、提现的时候有对应字段 |
    |  自动投标签约  |  有  |  有  |              必须              |
    |  自动债转授权  |  有  |  无  |              必须              |
    | 放款手续费授权 |  有  |  无  |  非必须（理财一期不强制授权）  |
    | 债转手续费授权 |  有  |  无  |              必须              |

    > 钜石提供一个 自动投标和自动债转的复合授权接口 **业务授权处理（authorization_p）**，通过该接口可以一次过对两项授权

  - 累加签约

    对于上述的类型，如果因为额度或者期限不足则只能调用签约累加页面接口**(sign_again_p)**逐项调整，对于调用复合授权接口的，也只能单项累加签约，需要复合授权的原签约流水号

    > 与累加签约接口类似的，当前用户的每项签约状态，如剩余期限和金额，都需要单独调用查询



- 坑点

  **钜石现在提供的签约状态查询接口只有签约时的金额，并没有返回剩余签约金额**



##### 提现

  - 原提现手续费需要经过校验授权和单独调用手续费收取接口，现钜石模式的收取无需授权，直接在提现接口传入fee字段，因此在保持原来手续费收取逻辑的前提下，去掉原来的授权和手续费收取接口调用。

    > 理财原来的手续费收取友比较复杂的判断逻辑，代码实现比较混乱，需要谨慎分析后才动手改动



##### 营销户

  - 发放：使用本文介绍过的红包户进行营销发放，包括所有因活动或者营销而直接出账给投资人的均需要调用该接口

  - 撤销：该接口可以在发放的资金没有出账的前提下撤销，该接口拯救了经常误发钱的财务人员

    > **注意点：** 红包撤销需要原交易流水号(**origin_serial_no**)，因此红包出账需要保存原交易流水

- 营销户充值 ：富友的红包户充值只能走 **红包网关充值接口(coupon_bank_recharge)** 充值



##### 资金冻结

  - 富友模式下的资金直接冻结和直接解冻是任意金额，理财系统在用户投资之后会直接冻结资金，在推送在匹配系统后，由它们直接解冻然后进行放款

    > 现流程图如下

    ```sequence
    
    Note left of 理财系统: 直接冻结用户对应投资金额
    理财系统->匹配系统: 推送投资资金 
    Note right of 匹配系统: 直接解冻用户部分或者全部对应投资金额
    ```

  - 钜石模式的资金冻结只有冻结和撤销的概念，而且都是整笔操作，无法部分解冻

    > 钜石流程图如下

    ```sequence
        
        Note left of 理财系统: 冻结用户对应投资金额
        理财系统->匹配系统: 推送投资资金，需要传原冻结资金流水号
        Note right of 匹配系统: 整笔撤销资金冻结，进行放款
    ```

  >  **难点**：若匹配单次放款没有完整使用完该笔资金，为避免平台与存管系统账务不平，则可能需要匹配再次冻结，并自行保存原冻结流水号



##### 忘记密码链接

- 钜石部分页面接口有入参字段**forget_pwd_url**，该字段如果传入则在该接口页面显示忘记密码链接，若不传则不显示，因此该链接需要封装和构造跳转到钜石另外的**充值密码页面(set_password_p)**



#####  存量用户迁移后的绑卡

- 存量用户迁移之后，钜石默认是开通他们的存管系统的电子账号，但是在初次交易之前需要重新绑卡校验四要素才能正常使用



####  表结构调整

> 本次对接必须要实现的代码调整，这里描述的为大概方向，具体落实具体再细分讨论

------



##### 新增新安存管银行信息表  

**t_xinan_user_info**

| 字段          | 字段类型 | 可否为空 | 字段备注                                       |
| ------------- | -------- | -------- | ---------------------------------------------- |
| id            | bigint   | 非空     | 主键id                                         |
| user_id       | bigint   | 非空     | 平台用户id                                     |
| cert_type     | varchar  | 非空     | 证件类型，默认"15"                             |
| cert_no       | varchar  | 非空     | 身份证证件号码                                 |
| card_no       | varchar  | 非空     | 钜石电子账户                                   |
| customer_no   | varchar  | 非空     | 客户号                                         |
| serial_no     | varchar  | 非空     | 三方绑定编号(绑卡是返回的编号，解绑的时候用到) |
| bank_card_no  | varchar  | 非空     | 银行卡号                                       |
| mobile        | varchar  | 非空     | 手机号码                                       |
| bank_name     | varchar  | 非空     | 银行名称                                       |
| out_serial_no | varchar  | 非空     | 申请流水号                                     |
| ran_amount    | decimal  | 可为空   | 企业户激活金额。。激活方式：线下指定金额来账   |
| acct_type     | int      | 非空     | 账户类型 0:出借人，1:借款人，2:企业户          |
| status        | int      | 非空     | 状态，1：有效，0：注销                         |
| remark        | varchar  | 可为空   | 备注字段                                       |
| time          | datetime | 非空     | 创建时间，即开户时间                           |
| update_time   | datetime | 可为空   | 更新时间                                       |
|               |          |          |                                                |
|               |          |          |                                                |



##### 新增新安签约明细表

**t_xinan_user_auth**

| 字段          | 字段类型 | 可否为空 | 字段描述                                                     |
| ------------- | -------- | -------- | ------------------------------------------------------------ |
| id            | bigint   | 非空     | 主键id                                                       |
| user_id       | bigint   | 非空     | 平台用户id                                                   |
| time          | datetime | 非空     | 签约时间                                                     |
| status        | int      | 非空     | 签约状态 1：有效，0：无效                                    |
| type          | varchar  | 非空     | 授权类型，自动债权转让签约trans、投资人自动投标签约 bid、转让方转让手续费签约transfer、放款手续费签约payment、借款人还款金额签约repayment |
| amount        | decimal  | 非空     | 授权金额累计最大金额                                         |
| unit_amount   | decimal  | 非空     | 单笔签约金额                                                 |
| start_time    | datetime | 非空     | 授权开始时间                                                 |
| end_time      | datetime | 非空     | 授权结束时间                                                 |
| out_serial_no | varchar  | 非空     | 签约流水号，累加签约需要用到                                 |
| update_time   | datetime | 可为空   | 更新时间                                                     |
| remark        | varchar  | 可为空   | 备注                                                         |
|               |          |          |                                                              |



##### 新增新安存管系统核心交易请求日志表

**t_xinan_log_requet**

| 字段          | 字段类型 | 可否为空 | 字段描述                                                     |
| ------------- | -------- | -------- | ------------------------------------------------------------ |
| id            | bigint   | 非空     | 主键id                                                       |
| user_id       | bigint   | 非空     | 平台用户id                                                   |
| time          | datetime | 非空     | 请求时间                                                     |
| type          | int      | 非空     | 交易类型(0：开户，1：签约，2：提现：3：充值，4：累加签约，5：绑卡，6：其他) |
| uuid          | varchar  | 非空     | 公共请求体标记为唯一交易流水，业务无关                       |
| out_serial_no | varchar  | 可为空   | 业务流水号，用于交易的唯一性标识，签约、红包发放，接口有传必须填充 |
| data          | varchar  | 非空     | 交易请求json串，包括请求头与请求体                           |
|               |          |          |                                                              |
|               |          |          |                                                              |
|               |          |          |                                                              |



##### 新增新安存管系统核心交易响应日志表

**t_xinan_log_reponse**

| 字段          | 字段类型 | 可否为空 | 字段描述                                                     |
| ------------- | -------- | -------- | ------------------------------------------------------------ |
| id            | bigint   | 非空     | 主键id                                                       |
| user_id       | bigint   | 非空     | 平台用户id                                                   |
| time          | datetime | 非空     | 响应时间                                                     |
| type          | int      | 非空     | 交易类型(0：开户，1：签约，2：提现：3：充值，4：累加签约，5：绑卡，6：其他)， |
| uuid          | varchar  | 非空     | 公共请求体标记为唯一交易流水，业务无关                       |
| out_serial_no | varchar  | 可为空   | 业务流水号，用于交易的唯一性标识，签约、红包发放，接口有响应必须填充 |
| order_id      | varchar  | 可为空   | 钜石部分接口会响应返回的订单号，用于后续查询状态所用，接口有返回必须填充 |
| data          | varchar  | 非空     | 交易响应json串，包括响应头与响应体                           |
| code          | varchar  | 非空     | 响应码                                                       |
| msg           | varchar  | 非空     | 响应描述                                                     |
|               |          |          |                                                              |

> 请注意！请注意！钜石接口表示订单号有使用order_id和order_no，两者的区别在于：
>
> **order_no：**一般用于接口请求入参，可以理解为钜石预留给平台使用，理财系统暂无应用场景，无需单独字段保存
>
> **order_id：**一般为钜石接口返回，用于后续查询该笔请求交易状态所用，需要单独字段保存



##### 修改 t_financialplan_record表

| 字段          | 字段类型 | 可否为空 | 字段描述                             |
| ------------- | -------- | -------- | ------------------------------------ |
| out_serial_no | varchar  | 可为空   | 资金冻结流水号，用于传给匹配或者撤销 |



##### 修改t_user_details表

| 字段   | 字段类型 | 可否为空 | 字段描述                               |
| ------ | -------- | -------- | -------------------------------------- |
| status | int      | 非空     | 交易状态（0：失败，1：成功 2：处理中） |



#### 技术代码调整

------



##### 请求与响应日志公共方法封装

待详细设计

> **注意点：**请求与响应参数需要通过公共请求和响应参数uuid关联



##### 页面接口同步回调地址转发封装

- 成功跳转地址(**success_url**)：理财所有页面接口成功跳转地址均使用同一个分发地址，在上送**success_url**参数的时，附加用户id和真正跳转地址参数，如 开户增加：**?realUrl=A&userId=12345&type=开户**、充值增加 **?realUrl=B&userId=12345&type=充值**，后台根据不同交易类型type进行不同业务处理和跳转
- 失败跳转地址(**fail_url**):处理方式同上



##### 回调地址统一封装处理

- 理财所有回调接口地址均使用同一个分发地址，但无需在url附加任何参数，回调响应参数一般比较详细，能获取本次交易的用户和交易信息，在分发地址接收到回调之后，根据不同交易进行不同业务处理和响应

> **注意点：**回调属于无状态请求，可能需要通过响应的uuid先查询出请求参数，再取出uuid



##### 忘记密码链接封装

- 忘记密码



##### 签约明细入库方法封装

待详细设计



#####  红包户出账方法封装

> 在SDK的基础上，进行业务封装，包括请求响应日志记录，并且需要注意红包户出账是 可用余额--->可用余额



##### 交易记录状态更新方法封装

- 充值和提现最终交易状态依赖于回调，因此需要平台交易记录表增加中间处理状态和失败状态
- 在页面处理成功后跳转同步地址需要增加中间状态，需要区分情况

  - 跳转成功地址：增加一条处理中交易明细，在回调回来明确交易状态后更新为成功或者失败
  - 跳转失败地址：直接增加一条失败的交易记录，若回调回来却为成功，则更新为成功

>**注意点：** 同步回调地址依赖于用户在银行页面点击确定按钮后才触发，极端情况，异步回调比同步更为优先触达，需要先判断再处理，以防最终状态被覆盖



##### 累加签约方法封装

待详细设计



##### 相关注解封装

1. 签约检查
2. 开户检查
3. 日志记录



#### 开发注意事项

1. 同步与异步回调顺序问题

   - 同步依赖于用户在银行页面点击开户结果后开始触达，极端情况下，有可能无同步回调或者比异步回调慢，因此在处理同步和异步回调时需要判空和防重处理

     > 处理原则是，同步回调是在后台接受到初步反馈后及时通知前端页面，部分业务需要在此时入库部分信息，并更新为处理中等中间状态，待最终的回调结果回来之后更新为最终状态



2. 钜石系统API中，存在部分相同业务意义的字段，但是字段命名却不一致，请务必注意



3. 钜石系统API中标记用户的字段和标记某次交易流水字段都有很多个，请务必看清接口需要上传的是哪个



# 附录

### 文档地址

- [钜石系统在线API]: https://apidata.rockfintech.com/doc/build/depositxinan.html

- [项目需求JIRA看板]: http://jira.gz-hzed.com/projects/XNYH/summary

- [原型地址]: https://axhub.im/pro/244bbe15eb82820a

- [SDK地址]: http://git.gz-hzed.com/architect_group/hzed-xinan-bank
